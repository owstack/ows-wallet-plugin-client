"use strict";var modules=["gettext","ngLodash","owsWalletPluginClient.api","owsWalletPluginClient.impl"],owsWalletPluginClient=angular.module("owsWalletPluginClient",modules);angular.module("owsWalletPluginClient.api",[]),angular.module("owsWalletPluginClient.impl",[]),angular.module("owsWalletPluginClient").run(["gettextCatalog",function(gettextCatalog){}]),angular.module("owsWalletPluginClient.impl").factory("ApiMessage",function($log,lodash){function ApiMessage(eventOrRequest,sequence){if(self=this,self.event={},lodash.isUndefined(sequence)){var event=eventOrRequest;if(lodash.isUndefined(event)||!(event instanceof MessageEvent))throw Error("event is not a MessageEvent");self.event=event,validateEvent();var data=JSON.parse(self.event.data);lodash.assign(self,data)}else{var request=eventOrRequest;self.header={sequence:lodash.isUndefined(sequence)?-1:sequence,id:""+(new Date).getTime(),timestamp:new Date},self.request=request||{},self.response={}}return self}function transport(){return{header:self.header,request:self.request,response:self.response}}function validateEvent(){if(lodash.isUndefined(self.event.data))throw self.response={statusCode:500,statusText:"Invalid message event, no 'data' found.",data:{}},new Error;if(!lodash.isString(self.event.data))throw self.response={statusCode:500,statusText:"Invalid message event data, expected string argument but received object.",data:{}},new Error}var self;return ApiMessage.prototype.send=function(host){$log.info("[client] REQUEST  "+self.header.sequence+": "+angular.toJson(transport())),host.postMessage(angular.toJson(transport()),"*")},ApiMessage.prototype.serialize=function(){return angular.toJson(transport())},ApiMessage}),angular.module("owsWalletPluginClient.impl").service("pluginClientService",function($log,$rootScope,$injector,$timeout,lodash,ApiMessage,CError){function init(){return window.addEventListener("message",receiveMessage.bind(this)),start(),this}function start(){var request={method:"POST",url:START_URL,data:{}};root.sendMessage(request).then(function(response){$log.info("[client] START: "+response.statusText+" ("+response.statusCode+")"),clientServiceState={statusCode:200,statusText:response.statusText},root.refreshScope(function(error){$rootScope.$emit("Client/Start",error)})},function(error){$log.error("[client] START ERROR: "+error.message+" ("+error.statusCode+")"),clientServiceState={statusCode:error.statusCode,statusText:error.message},$rootScope.$emit("Client/Start",error)})}function clientServiceIsOK(){return clientServiceState.statusCode>=200&&clientServiceState.statusCode<=299}function isStartMessage(message){return message.request.url==START_URL}function receiveMessage(event){var message;try{message=new ApiMessage(event);var promiseIndex=lodash.findIndex(promises,function(promise){return promise.id==message.header.id});if(promiseIndex>=0){var promise=lodash.pullAt(promises,promiseIndex);$timeout.cancel(promise[0].timer),promise[0].onComplete(message)}else $log.debug("Message received but there is no promise to fulfill: "+message.serialize())}catch(ex){$log.error("[client] ERROR: invalid message received, "+ex.message+" - "+angular.toJson(event))}}function timeout(message){$log.debug("Applet client request timeout: "+message);var promiseIndex=lodash.findIndex(promises,function(promise){return promise.id==message.header.id});if(promiseIndex>=0){var promise=lodash.pullAt(promises,promiseIndex);message.response={statusCode:408,statusText:"Request timed out.",data:{}},promise[0].onComplete(message)}else $log.debug("Message request timed out but there is no promise to fulfill: "+message.serialize())}var root={},host=window.parent,REQUEST_TIMEOUT=3e3,START_URL="/start",SCOPE_URL="/scope",clientServiceState={statusCode:-1,statusText:""},sequence=0,promises=[];return root.sendMessage=function(request){return new Promise(function(resolve,reject){var onComplete=function(message){if(message.response.statusCode>=200&&message.response.statusCode<=299){if(lodash.isUndefined(message.request.responseObj))responseObj=message.response;else{var responseObj=$injector.get(message.request.responseObj);responseObj=eval(new responseObj(message.response.data.obj))}resolve(responseObj)}else{var responseObj=new CError(message);reject(responseObj)}},message=new ApiMessage(request,sequence++);if(clientServiceIsOK()||isStartMessage(message)){var timeoutTimer=$timeout(function(){timeout(message)},REQUEST_TIMEOUT);promises.push({id:message.header.id,onComplete:onComplete,timer:timeoutTimer}),message.send(host)}else message.response={statusCode:503,statusText:"Client service is not ready.",data:{}},onComplete(message)})},root.refreshScope=function(callback){var request={method:"GET",url:SCOPE_URL};root.sendMessage(request).then(function(response){$log.info("[client] SCOPE: "+response.statusText+" ("+response.statusCode+")"),$rootScope.env=response.data.env,$rootScope.applet=response.data.applet,$timeout(function(){$rootScope.$apply()}),callback&&callback()},function(error){$log.error("[client] SCOPE ERROR: "+error.message+" ("+error.statusCode+")"),callback(error)})},init(),root}),angular.module("owsWalletPluginClient.api").factory("CApplet",function(lodash,pluginClientService){function CApplet(applet){return lodash.assign(this,applet),_applet=applet,this}var _applet;return CApplet.prototype.initService=function(pluginId){var request={method:"POST",url:"/applet/"+this.header.id+"/service/"+pluginId+"/init",data:{}};pluginClientService.sendMessage(request)},CApplet.prototype.hideSplash=function(){var request={method:"POST",url:"/applet/"+this.header.id+"/config",data:{showSplash:!1}};pluginClientService.sendMessage(request)},CApplet.prototype.property=function(name,value){var request={method:"POST",url:"/applet/"+this.header.id+"/property/"+name,data:{value:value}};pluginClientService.sendMessage(request).then(function(value){return pluginClientService.refreshScope(),value})},CApplet.prototype.propertySet=function(set){var request={method:"POST",url:"/applet/"+this.header.id+"/propertyset",data:{set:set}};pluginClientService.sendMessage(request).then(function(response){pluginClientService.refreshScope()})},CApplet}),angular.module("owsWalletPluginClient.api").factory("CBitPayInvoicePaymentService",function(pluginClientService){function CBitPayInvoicePaymentService(serviceDesc){}return CBitPayInvoicePaymentService.prototype=new AbstractPaymentService,CBitPayInvoicePaymentService.prototype.getPaymentRequest=function(){return self.paymentRequest},CBitPayInvoicePaymentService.prototype.createPaymentRequest=function(data,callback){var postData={token:self.api.auth.token,guid:self.guid(),price:data.price,currency:data.currency,orderId:data.orderId,itemDesc:data.itemDesc,itemCode:data.itemCode,posData:data.posData,physical:data.physical,buyer:{name:data.name,address1:data.address1,address2:data.address2,locality:data.locality,region:data.region,postalCode:data.postalCode,country:data.country,email:data.email,phone:data.phone,notify:data.notify},transactionSpeed:self.api.transactionSpeed,notificationEmail:self.api.notificationEmail,notificationURL:self.api.notificationURL};return $rootScope.$emit("Local/PaymentServiceStatus",gettext("Fetching payment instructions")),self.post("/invoices",postData,function(err,response){if($rootScope.$emit("Local/PaymentServiceStatus"),err)return callback(err);$log.debug("Invoice created: "+JSON.stringify(response.data)),self.paymentRequest=response.data,callback()}),self},CBitPayInvoicePaymentService.prototype.sendPayment=function(memo,callback){$rootScope.$emit("Local/PaymentServiceStatus",gettext("Sending payment")),AbstractPaymentService.sendPayment({payProUrl:self.paymentRequest.data.paymentUrls.BIP73,memo:memo},function(err){$rootScope.$emit("Local/PaymentServiceStatus"),callback(err)})},CBitPayInvoicePaymentService.prototype.createAndSendPayment=function(data,memo,callback){self.createPaymentRequest(data,function(err,response){if(err)return callback(err);self.sendPayment(memo,function(err){return callback(err)})})},CBitPayInvoicePaymentService}),angular.module("owsWalletPluginClient.api").factory("CConst",function(){function CConst(){return this}return CConst.BITS_PER_BTC=1e6,CConst.SATOSHI_PER_BTC=1e8,CConst}),angular.module("owsWalletPluginClient.api").factory("CContext",function(pluginClientService){function CContext(){return this}function sessionId(){var sessionId=window.location.search.substring(window.location.search.indexOf("sessionId=")+10);return sessionId.indexOf("&")>=0&&(sessionId=sessionId.substring(0,sessionId.indexOf("&"))),sessionId}return CContext.getSession=function(){var request={method:"GET",url:"/session/"+sessionId(),responseObj:"CSession"};return pluginClientService.sendMessage(request)},CContext}),angular.module("owsWalletPluginClient.api").factory("CError",function(lodash){function CError(message){return lodash.assign(this,message),this.statusCode=this.response.statusCode,this.message=this.response.statusText,this}return CError}),angular.module("owsWalletPluginClient.api").factory("CPlugin",function($log,CSystem,PluginRegistry){function CPlugin(){return this}return CPlugin.getRegistryEntry=function(pluginId){var request={method:"GET",url:"/plugin-registry?id="+pluginId};return pluginClientService.sendMessage(request)},CPlugin.validateServiceDesc=function(serviceDesc,requiredProperties,pluginId){var result=CSystem.checkObject(serviceDesc,requiredProperties);if(result.missing.length>0)throw new Error("Error: A skin with service plugin '"+pluginId+"' is missing required properties '"+result.missing.toString()+"'");result.other.length>0&&$log.warn("Warning: A skin with service plugin '"+pluginId+"' has unrecognized properties '"+result.other.toString()+"'")},CPlugin}),angular.module("owsWalletPluginClient.api").factory("CSession",function(lodash,pluginClientService,CApplet){function CSession(appletSession){return lodash.assign(this,appletSession),_session=appletSession,this}var _session;return CSession.prototype.flush=function(){var request={method:"POST",url:"/session/flush"};return pluginClientService.sendMessage(request)},CSession.prototype.get=function(name){var request={method:"GET",url:"/session/"+this.id+"/var/"+name};return pluginClientService.sendMessage(request)},CSession.prototype.getApplet=function(){var request={method:"GET",url:"/session/"+this.id+"/applet",responseObj:"CApplet"};return pluginClientService.sendMessage(request)},CSession.prototype.restore=function(){var request={method:"POST",url:"/session/"+this.id+"/restore",data:{}};pluginClientService.sendMessage(request)},CSession.prototype.set=function(name,value,publish){var request={method:"POST",url:"/session/"+this.id+"/var/"+name+(publish?"/publish":""),data:{value:value}};pluginClientService.sendMessage(request).then(function(response){publish&&pluginClientService.refreshScope()})},CSession}),angular.module("owsWalletPluginClient.api").factory("CSystem",function(){function CSystem(){return this}function iterateObj(obj,stack){var properties=[];for(var property in obj)obj.hasOwnProperty(property)&&("object"==typeof obj[property]?(properties.push(stack+"."+property),properties=properties.concat(iterateObj(obj[property],stack+"."+property))):properties.push(stack+"."+property));return properties}return CSystem.checkObject=function(obj,requiredProperties){for(var properties=iterateObj(obj,""),missing=[],other=[],i=0;i<requiredProperties.length;i++)properties.indexOf(requiredProperties[i])<0&&missing.push(requiredProperties[i]);for(var i=0;i<properties.length;i++)requiredProperties.indexOf(properties[i])<0&&other.push(properties[i]);return{missing:missing,other:other}},CSystem}),angular.module("owsWalletPluginClient.api").factory("CUtils",function(rateService){function CUtils(){return this}return CUtils.getRate=function(isoCode){return rateService.getRate(isoCode)},CUtils}),angular.module("owsWalletPluginClient.api").factory("CWallet",function(configService,txFormatService,FocusedWallet){function CWallet(){return this}return CWallet.getCurrencyName=function(){return configService.getSync().wallet.settings.unitName},CWallet.getCurrencyCode=function(){return configService.getSync().wallet.settings.unitCode},CWallet.getAltCurrencyName=function(){return configService.getSync().wallet.settings.alternativeName},CWallet.getAltCurrencyIsoCode=function(){return configService.getSync().wallet.settings.alternativeIsoCode},CWallet.getUnitToSatoshi=function(){return configService.getSync().wallet.settings.unitToSatoshi},CWallet.getUnitDecimals=function(){return configService.getSync().wallet.settings.unitDecimals},CWallet.formatAmount=function(amount){return txFormatService.formatAmount(amount)},CWallet.sendPayment=function(data,callback){return FocusedWallet.getInstance().sendPayment(data,callback)},CWallet});